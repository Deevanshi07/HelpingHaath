<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Need Help – Details</title>
  <link rel="stylesheet" href="frame4.css" />
  <style>
    .required { color: red; margin-left: 4px; }
    .field-error { outline: 2px solid red; }
    .disabled { opacity: 0.7; pointer-events: none; }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.png" alt="logo" />
    </div>
  </header>

  <div class="form-container">
    <form id="needHelpForm" class="donation-form" novalidate>
      <h2>Need Help – Enter Details</h2>

      <!-- ✅ Title field added -->
      <label for="title">Title<span class="required">*</span></label>
      <input type="text" id="title" placeholder="Short title (e.g. Medical Help for Father)" required />

      <label for="name">Name<span class="required">*</span></label>
      <input type="text" id="name" placeholder="Enter your full name" required />

      <div class="form-group">
        <label for="type">Choose Type<span class="required">*</span></label>
        <select id="type" required>
          <option value="">Select</option>
          <option value="Student">Student</option>
          <option value="TeachingStaff">Teaching Staff</option>
          <option value="NonTeachingStaff">Non-Teaching Staff</option>
        </select>
      </div>

      <div class="form-group">
        <label for="contact">Contact Number<span class="required">*</span></label>
        <input type="text" id="contact" placeholder="Enter contact number" required />
      </div>

      <div class="form-group">
        <label for="email">Email Id<span class="required">*</span></label>
        <input type="email" id="email" placeholder="Enter your email" required />
      </div>

      <div class="form-group">
        <label for="description">Description<span class="required">*</span></label>
        <textarea id="description" placeholder="Explain why you need donations" required></textarea>
      </div>

      <div class="form-group">
        <label for="income">Monthly Income<span class="required">*</span></label>
        <select id="income" required>
          <option value="">Select</option>
          <option value="Below 10000">Below 10000</option>
          <option value="10000-20000">10000-20000</option>
          <option value="20000-30000">20000-30000</option>
          <option value="30000-40000">30000-40000</option>
          <option value="40000-50000">40000-50000</option>
          <option value="Above 50000">Above 50000</option>
        </select>
      </div>

      <div class="form-group">
        <label for="targetAmount">Target Amount (₹)<span class="required">*</span></label>
        <input type="number" id="targetAmount" min="1" placeholder="e.g. 7000" required />
      </div>

      <button type="button" id="saveNextBtn" class="submit-btn">Save and Next</button>
    </form>
  </div>

  <script>
    const API = "http://localhost:3000";
    const getVal = (id) => (document.getElementById(id)?.value || "").trim();

    const fields = ["title", "name", "type", "contact", "email", "description", "income", "targetAmount"];

    document.getElementById("saveNextBtn").addEventListener("click", async () => {
      fields.forEach((id) => document.getElementById(id)?.classList.remove("field-error"));

      const payload = {
  title: getVal("title"),
  name: getVal("name"),
  type: getVal("type"),
  contact: getVal("contact"),
  email: getVal("email"),
  description: getVal("description"),
  income: getVal("income"),
  goal: Number(getVal("targetAmount")) || 0,
  status: "active"            // ✅ add this
};


      // Basic validation
      for (const id of fields) {
        const val = id === "targetAmount" ? payload.goal : payload[id];
        if (!val) {
          document.getElementById(id)?.classList.add("field-error");
          document.getElementById(id)?.focus();
          return alert("Please fill all required fields.");
        }
      }

      if (payload.goal <= 0) {
        document.getElementById("targetAmount")?.classList.add("field-error");
        return alert("Target amount must be positive.");
      }

      const btn = document.getElementById("saveNextBtn");
      btn.disabled = true;
      btn.textContent = "Saving...";

      try {
        const res = await fetch(`${API}/api/campaigns`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Save failed");

        // Store campaign for next page
        localStorage.setItem("campaignId", data.campaign._id);
        localStorage.setItem("campaignData", JSON.stringify(payload));

        alert("Saved successfully!");
        location.href = `frame21.html?campaignId=${encodeURIComponent(data.campaign._id)}`;
      } catch (err) {
        console.error(err);
        alert(err.message || "Failed to save");
      } finally {
        btn.disabled = false;
        btn.textContent = "Save and Next";
      }
    });
  </script>
</body>
</html>
